# The Escrow Zapp

This app is originally generated by Starlight but has many enhancements to make
the app perform better as well as enhancements in the Solidity code. These
enhancements have not yet been added to Starlight's code generation logic yet.

# Building The Microservices

A starlight instance is made up of a number of microservices:

- zapp-escrow: this is the main client app
- timber: manages the merkle tree for the local states
- zokrates-worker: this is the proof generation engine, based on the zokrates
  binary
- mongo: used by the zapp and timber to save the commitments and the state
  merkle tree, respectively

## The Escrow Zapp

This runtime hosts the API to interact with the various smart contracts (ERC20
and EscrowShield). It also manages the signing keys for submitting transactions.

The zkSNARK trusted setup was performed with the output proving keys and
verification keys commited in the `proving-files` folder. For production
purposes, to the extent that you feel comfortable building applications for
PoC/Pilot purposes with this framework, you would want to perform your own
trusted setup ceremony.

```console
$ cd zapps/Escrow
$ docker build -t starlight-mongo -f Dockerfile.mongo .
```

## Timber

Because Starlight's shielded token contract is based on UXTOs, the client
application must keep track of every state update event in order to make sure
UTXOs owned by the local instance are properly indexed and taken into account
when figuring out balances, and assembling transaction inputs in order to
support transfer or withdraw operations.

To build this component, we need a forked repository from Kaleido. Clone the
following repository and checkout the `config` branch:

```console
$ git clone https://github.com/kaleido-io/timber.git
$ git checkout config
$ cd merkle-tree
$ docker build -t timber .
```

## Mongo

```console
$ cd zapps/Escrow
$ docker build -t starlight-mongo -f Dockerfile.mongo .
```

# Start up

For this tutorial, we will start two instances of Starlight, one for `sender`
and one for `receiver`.

- Start the Ethereum blockchain Ganache is a great choice for local testing if
  you don't already have an Ethereum network:

```console
$ docker run -p 8545:8545 --name ganache --network starlight trufflesuite/ganache:v7.4.4 --chain.networkId 1337 --gasPrice 0 -k berlin --miner.blockGasLimit 0x11e1a300 --logging.verbose true --logging.debug true
ganache v7.4.3 (@ganache/cli: 0.5.3, @ganache/core: 0.5.3)
Starting RPC server

Available Accounts
==================
(0) 0xbDdA3B7A3c5723977ea31868217054beF3c39F37 (1000 ETH)
(1) 0x26D348C44f74E4254ABB0ED9bfEdCDE66Cc99EDd (1000 ETH)
(2) 0x83B3681b990168363348711233e6E02eba519a61 (1000 ETH)
(3) 0xBd20e44FFcD0984963C0d65Fc85598105f1C12D8 (1000 ETH)
(4) 0xc6Ea12415d4E8acB3Bd41E9C0Ad7E73ffb447484 (1000 ETH)
(5) 0xEbB82901B9860e3c68A8D2506309855348224C70 (1000 ETH)
(6) 0xF3F87f56c2cBfb88480416E00fFAEf46D8570E4c (1000 ETH)
(7) 0x83348B5aa83392D54A0940B35c6a36fAC3318061 (1000 ETH)
(8) 0xD1B95D46507e25ADA83Fc80377C31c8231CA1585 (1000 ETH)
(9) 0xD543C4acc87C09Be7390a69B78F51A51c171aB2f (1000 ETH)

Private Keys
==================
(0) 0xb17dd1d641d93434ca6632c13b68ac330b594d6d4031b980b8f4921b868199fa
(1) 0xbf11d586ae602d9ca881dcbf662bce7a654618cf62ed89dfb84135e0cdc47151
(2) 0xc290e5fe3d8464cdb1312b9798db1d924fdf72ff342aa27df42b49ca67f0051a
(3) 0x05672dac18cc3a364512920bd7fd2c66b62a5beb24d51a11557a0b511d8063ed
(4) 0xfd639c6261da626126f9a3b7882c535abe6babbe3d4b3f0dfbaef3bdfb7430da
(5) 0x5c7a60671e3c42bf0988bd62811be1f2a10b088c31c91a3bf0c94b46a608657c
(6) 0x853631ddbf3b68fade40ef5ade4802a75e9312c1d2b88d8d667020bf6682c7bc
(7) 0xe20eda7e620d68c3574f352985ef473f6762536354cee27489116fafe0c04493
(8) 0x08576d3fc23b4a638b619c2632e50b18a4fc88f2d12604626651e2c25faae18d
(9) 0xfb8324f62749f6abeb839011aaefbe01b2e05531ab36a23a61622197e9c814b7

HD Wallet
==================
Mnemonic:      faint below organ fluid guitar student width figure lab reduce marriage snack
Base HD Path:  m/44'/60'/0'/0/{account_index}

Default Gas Price
==================
0

BlockGas Limit
==================
300000000

Call Gas Limit
==================
50000000

Chain Id
==================
1337

RPC Listening on 0.0.0.0:8545
```

- Deploy the contracts For the Escrow privacy token, the main smart contracts
  are the ERC20 and the EscrowShield contracts. They are available in the
  `contracts` folder and can be deployed using Truffle:

```console
$ truffle deploy --network development
Compiling your contracts...
===========================
> Everything is up to date, there is nothing to compile.


Starting migrations...
======================
> Network name:    'development'
> Network id:      1337
> Block gas limit: 300000000 (0x11e1a300)


1_initial_migration.js
======================

   Replacing 'Migrations'
   ----------------------
   > transaction hash:    0x25dc5340e80de65c4a61549155e1d30065f765f77f79a82b23cf4aed449771ae
   > Blocks: 0            Seconds: 0
   > contract address:    0x2110948C5EcbE87D7169d0Ff685e15B5788146F2
   > block number:        2
   > block timestamp:     1705424092
   > account:             0xbDdA3B7A3c5723977ea31868217054beF3c39F37
   > balance:             1000
   > gas used:            201175 (0x311d7)
   > gas price:           0 gwei
   > value sent:          0 ETH
   > total cost:          0 ETH

   > Saving migration to chain.
   > Saving artifacts
   -------------------------------------
   > Total cost:                   0 ETH


2_shield.js
===========

   Replacing 'Pairing'
   -------------------
   > transaction hash:    0x709daae37fb020cdccc6b250ff96538c1c5868ea72f917a1627e51a3373d8d4a
   > Blocks: 0            Seconds: 0
   > contract address:    0x98A88A1DE972fE1f38A5D3039D547254094bCbe0
   > block number:        4
   > block timestamp:     1705424092
   > account:             0xbDdA3B7A3c5723977ea31868217054beF3c39F37
   > balance:             1000
   > gas used:            72269 (0x11a4d)
   > gas price:           0 gwei
   > value sent:          0 ETH
   > total cost:          0 ETH


   Replacing 'Verifier'
   --------------------
   > transaction hash:    0x7a0d4103a232216d1279382e2d8bff01500cedde818589b53c5307f4535ff093
   > Blocks: 0            Seconds: 0
   > contract address:    0xfB7c009967a2Afd6340063C9391c89F0681E7089
   > block number:        5
   > block timestamp:     1705424092
   > account:             0xbDdA3B7A3c5723977ea31868217054beF3c39F37
   > balance:             1000
   > gas used:            2329082 (0x2389fa)
   > gas price:           0 gwei
   > value sent:          0 ETH
   > total cost:          0 ETH


   Replacing 'ERC20'
   -----------------
   > transaction hash:    0x10a5fa66d1c0ff38247d7166744865b08b1f2876711c0e16f900a74062ede08f
   > Blocks: 0            Seconds: 0
   > contract address:    0xe0aa4EA405333EbF39fB791bc731980bf320Ff99
   > block number:        6
   > block timestamp:     1705424092
   > account:             0xbDdA3B7A3c5723977ea31868217054beF3c39F37
   > balance:             1000
   > gas used:            1396105 (0x154d89)
   > gas price:           0 gwei
   > value sent:          0 ETH
   > total cost:          0 ETH


   Replacing 'EscrowShield'
   ------------------------
   > transaction hash:    0x5cb0ad1b8556787d42b8edde0008112de6ee3e5e26c3949ad94c4eba2a7a37cc
   > Blocks: 0            Seconds: 0
   > contract address:    0x8C33fA7E8446F061f001c863840F291021414dF2
   > block number:        7
   > block timestamp:     1705424092
   > account:             0xbDdA3B7A3c5723977ea31868217054beF3c39F37
   > balance:             1000
   > gas used:            6948015 (0x6a04af)
   > gas price:           0 gwei
   > value sent:          0 ETH
   > total cost:          0 ETH

   > Saving migration to chain.
   > Saving artifacts
   -------------------------------------
   > Total cost:                   0 ETH

Summary
=======
> Total deployments:   5
> Final cost:          0 ETH
```

- Start the zokrates worker instances: For the following command, we assume the
  `starlight` project has been checked out in the folder `/tmp`.

```console
$ docker run -v /tmp/starlight/zapps/Escrow/proving-files:/app/output -v /tmp/starlight/zapps/Escrow/circuits:/app/circuits -v /tmp/starlight/zapps/Escrow/orchestration/common/write-vk.mjs:/app/write-vk.mjs -v /tmp/starlight/zapps/Escrow/orchestration/common/db:/app/orchestration/common/db --name zokrates-sender --network starlight -d ghcr.io/eyblockchain/zokrates-worker-starlight:v0.2
$ docker run -v /tmp/starlight/zapps/Escrow/proving-files:/app/output -v /tmp/starlight/zapps/Escrow/circuits:/app/circuits -v /tmp/starlight/zapps/Escrow/orchestration/common/write-vk.mjs:/app/write-vk.mjs -v /tmp/starlight/zapps/Escrow/orchestration/common/db:/app/orchestration/common/db --name zokrates-receiver --network starlight -d ghcr.io/eyblockchain/zokrates-worker-starlight:v0.2
```

- Start the mongo db servers: Each instance will have 2 mongo servers, one used
  by timber and one used by the app itself.

```console
$ docker run -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -e MONGO_INITDB_DATABASE=merkle_tree -d --name timber-mongo-sender --network starlight starlight-mongo
$ docker run -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -e MONGO_INITDB_DATABASE=merkle_tree -d --name timber-mongo-receiver --network starlight starlight-mongo
$ docker run -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -e MONGO_INITDB_DATABASE=merkle_tree -d --name zapp-mongo-sender --network starlight starlight-mongo
$ docker run -e MONGO_INITDB_ROOT_USERNAME=admin -e MONGO_INITDB_ROOT_PASSWORD=admin -e MONGO_INITDB_DATABASE=merkle_tree -d --name zapp-mongo-receiver --network starlight starlight-mongo
```

- Start the timber servers: Note that before launching the timber instances, the
  contracts in the `zapps/Escrow` project must be compiled with Truffle first.
  This can either be accomplished with the `truffle compile` command, or it will
  have already been compiled if they have been deployed using Truffle. The
  folder `zapps/Escrow/build/contracts` contains the JSON files that timber uses
  to get the ABI for the various contract calls.

```console
$ docker run -e RPC_URL=ws://ganache:8545 -e DB_URL=mongodb://timber-mongo-sender:27017 -e HASH_TYPE=mimc -e UNIQUE_LEAVES=true -e ESCROW_SHIELD_ADDRESS=0x8C33fA7E8446F061f001c863840F291021414dF2 -v /tmp/starlight/zapps/Escrow/build/contracts:/app/build/contracts --network starlight --name timber-sender -d timber
$ docker run -e RPC_URL=ws://ganache:8545 -e DB_URL=mongodb://timber-mongo-receiver:27017 -e HASH_TYPE=mimc -e UNIQUE_LEAVES=true -e ESCROW_SHIELD_ADDRESS=0x8C33fA7E8446F061f001c863840F291021414dF2 -v /tmp/starlight/zapps/Escrow/build/contracts:/app/build/contracts --network starlight --name timber-receiver -d timber
```

- Start the app servers: Take the ERC20 and the EscrowShield contract addresses
  from the deploy step above, and use them in the launch commands below.

```console
$ docker run -p 3000:3000 -e ESCROW_SHIELD_ADDRESS=0x8C33fA7E8446F061f001c863840F291021414dF2 -e ERC20_ADDRESS=0xe0aa4EA405333EbF39fB791bc731980bf320Ff99 -e ZOKRATES_URL=http://zokrates-sender:80 -e TIMBER_URL=http://timber-sender:3001 -e RPC_URL=ws://ganache:8545 -e DEFAULT_ACCOUNT=0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1 -e KEY=0x4f3edf983ac636a65a842ce7c78d9aa706d3b113bce9c46f30d7d21715b23b1d -e MONGO_URL=mongodb://admin:admin@zapp-mongo-sender:27017 --network starlight --name zapp-sender -d zapp-escrow
$ docker run -p 3001:3000 -e ESCROW_SHIELD_ADDRESS=0x8C33fA7E8446F061f001c863840F291021414dF2 -e ERC20_ADDRESS=0xe0aa4EA405333EbF39fB791bc731980bf320Ff99 -e ZOKRATES_URL=http://zokrates-receiver:80 -e TIMBER_URL=http://timber-receiver:3001 -e RPC_URL=ws://ganache:8545 -e DEFAULT_ACCOUNT=0x4b4aF70A04F07E433005Ff63d4928df867a34b8B -e KEY=0x3cc4cdf446a16e09e3a47ae37b25cdc683b50b881523a23db81adffe1cc745d6 -e MONGO_URL=mongodb://admin:admin@zapp-mongo-receiver:27017 --network starlight --name zapp-receiver -d zapp-escrow
```

Note that the ERC20 sample contract used here have an unguarded `mint` function.
Typical ERC20 implementations have the `mint` function protected by a special
role or modifier. In that case, you need to set additional environment variables
when launching the app, to provide the signing key and account that can call
mint:

```console
-e ADMIN_ACCOUNT=0x... -e ADMIN_KEY=0x...
```

# Test the application

Use the postman collection included in the root folder to test the application:

1. `mint` to give the sender and receiver some ERC20 tokens
2. `approve` to approve the EscrowShield contract to take tokens in the deposit
   step
3. `deposit` to convert part of the ERC20 balance to shielded tokens. Note that
   this must be called at least twice to generate enough UTXOs needed to do
   transfer or withdraw calls
4. `get all commitments` to list the resulting commitments owned by the
   instance. The balance is printed in the console window (by adding together
   all the decrypted values from the UTXOs owned by the instance)
5. `transfer` to transfer to another account
6. `withdraw` to convert shielded tokens back to ERC20 balances
